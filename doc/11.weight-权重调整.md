[TOC]

## 服务权重路由

### 概述

​     Smart Discovery权重路由（Discovery weight）通过对服务路由过滤之后的服务列表进行设置权重，实现基于权重的服务路由、基于权重调整的蓝绿发布等场景。其中，服务权重设置支持服务提供方通过服务元数据进行设定，也可支持由服务消费方通过指定的服务提供方权重类型值（比如按提供方host）分别进行权重设定。

​     Smart Discovery通过对Ribbon的IRule规则进行扩展增强，来实现可基于权重规则的服务路由。


### 权重路由规则

#### 规则参数说明

| 参数名      | 是否必填 | 参数说明                                                     |
| ----------- | :------- | ------------------------------------------------------------ |
| serviceId   | 是       | 作用的服务Id，不配置情况下表示作用于所有服务                 |
| conditions  | 否       | 条件规则，用于匹配支持的服务消费方，可配置当服务调用方满足某个条件的情况下启用此权重配置，例如：application=demo-a；具体可参见条件规则详解章节。 |
| enabled     | 否       | 是否启用，默认true                                           |
| description | 否       | 规则描述                                                     |
| priority    | 否       | 规则优先级，默认值0                                          |
| type        | 否       | 权重类型，服务消费方通过指定的服务提供方权重类型值分别进行权重设定。例如：host、version、region、tag等。当权重值由服务提供方通过服务元数据进行设定则不需要配置此参数 |
| weightMap   | 否       | 权重分配情况，key为权重类型值，value为权重值，通过计算每个服务提供方占权重总和比率来计算服务提供方的访问概率。当权重值由服务提供方通过服务元数据进行设定则不需要配置此参数 |

​             

#### 规则配置示例

> 服务提供方的权重设置支持两种方式：
>
> - 1）服务提供方通过服务元数据进行设定
>
> - 2）服务消费方通过指定的服务提供方权重类型值（比如按提供方host）分别进行权重设定
>
>   其中：2）优先级高于1）；当获取到所有服务提供方的权重值为空，则不启用权重路由。

##### 服务消费方通过规则配置设置weight权重值

> 即根据type、weightMap获取到的配置weigths权重值，计算各个服务提供方的权重比率。

- 全局配置

> 全局配置serviceId为空，即作用于所有的服务消费方，默认情况下指定服务配置优先级高于全局配置。
>
> 如下示例表示version值1.0的服务提供方权重为10，version值2.0的服务提供方权重为90，并且此规则作用于所有的服务提供方。

```java
 "weights": [
     {
       "type": "version", #权重类型
       "weightMap": {
         "1.0": 10,
         "1.1": 90
       },
       "priority": 0,
       "enabled" :true
     }
   ]
```

- 指定服务配置

  > 指定的serviceId服务ID，即作用于此服务提供方。
  >
  > 如下示例表示host值192.168.10.1的服务提供方权重为10，host值192.168.10.1的服务提供方权重为90，此规则仅作用于discovery-springcloud-demo-b服务提供方和demo-a消费者。

```java
"weights": [
    {
      "serviceId": "discovery-springcloud-demo-b",
      "conditions": "application=demo-a",  #匹配服务消费者
      "type": "host",
      "weightMap": {
        "192.168.10.1": 10,
        "192.168.10.2": 90
      },
      "priority": 0,
      "enabled" :true
    }
  ]
```



##### 由服务提供方设置weight权重值

> 服务提供方通过服务元数据进行设定权重值，并配置作用的服务提供方或消费者，例如：

- 步骤1：分别为各服务提供方配置权重

  ```
  spring:
    cloud:
      nacos:
        discovery:
          metadata:
            weight: 10
  ```

- 步骤2：配置权重规则

```java
"weights": [
    {
      "serviceId": "discovery-springcloud-demo-b",
      "conditions": "application=demo-a",  #匹配服务消费者
      "priority": 0,
      "enabled" :true
    }
  ]
```



### 基于权重调整实现蓝绿发布

​     蓝绿发布，是在生产环境稳定集群之外，额外部署一个与稳定集群规模相同的新集群，并通过流量控制，逐步引入流量至新集群直至100%，原先稳定集群将与新集群同时保持在线一段时间，期间发生任何异常，可立刻将所有流量切回至原稳定集群，实现快速回滚。直到全部验证成功后，下线老的稳定集群，新集群成为新的稳定集群。 

​     蓝绿部署可以作为灰度发布权重规则的一种特殊形式，通过调整两个服务的请求量比例来控制线上是蓝版本还是绿版本。通过设置权重 X 为 100 或者 0 来达到蓝绿切换。 

 