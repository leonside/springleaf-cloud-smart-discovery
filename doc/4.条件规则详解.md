[TOC]

## 条件规则详解

> Smart Discovery参照Dubbo路由规则的条件表达式实现，提供简易、直观的条件规则配置。开发者也可以通过扩展自定义的条件规则实现，详见扩展性设计章节。



### 格式

例如，如下示例表示主机IP是10.20.153.10的消费者路由主机IP不为172.22.3.91的服务提供方：

```java
    host = 10.20.153.10 => host != 172.22.3.91
```

   => 之前的为消费者匹配条件，所有参数和消费者的服务元数据信息进行对比，当消费者满足匹配条件时，对该消费者执行后面的过滤规则。
   => 之后为提供者地址列表的过滤条件，所有参数和提供者的服务元数据信息进行对比，消费者最终只拿到过滤后的地址列表。

其中：

- 如果匹配条件为空或true，表示对所有消费方应用，如：=> host != 10.20.153.11
- 如果过滤条件为空，表示禁止访问，如：host = 10.20.153.10 =>
- 如果条件为*，表示匹配所有，如：host = 10.20.153.10 => *
- 如果匹配条件为false，表示访问过滤条件不匹配到的服务，如 #{#request.getParameter("name").equals("张三")} => host=10.20.153.10;当参数匹配false则路由值host不为10.20.153.10的其他服务。为实现灰度发布

### 表达式

#### 参数支持

> 支持服务基础属性、自定义服务元数据、服务请求参数等

- 服务基础元数据属性：如：host、port、application等，此部分为服务的基础信息，框架启动的时候会自动填充。
  - host：主机IP
  - port：主机端口 
  - application：应用名，即服务ID

- 服务自定义元数据信息：通过对metadata自定义配置，通常如：group、weight、region、tag、version等，可由开发自行配置，例如采用nacos为注册中心，服务元数据配置如下：

  ```java
  spring:
    cloud:
      nacos:
        discovery:
          server-addr: localhost:8848
          metadata:
            group: groupA
            version: 1.0
            region: dev
            tag: tagA
            weight: 20
  ```

为简化配置，框架同时也支持环境变量传递服务元数据定义，以“metadata.”打头，例如： metadata.group=groupA

- 服务调用信息：服务请求参数，支持SpEL表达式通过request内置对象获取参数信息，如 #{#request.getHeader("version")}获取（服务调用信息仅作用于服务条件路由下）

#### 条件支持

- 等号 = ：表示"匹配"，如：host = 10.20.153.10
- 不等号 !=： 表示"不匹配"，如：host != 10.20.153.10

#### 值支持

- 以逗号 , 分隔多个值，如：host != 10.20.153.10,10.20.153.11
- 以星号 * 开始、结尾、中间，表示通配，如：host != 10.20.* 
- 以美元符 $ 开头，表示引用消费者参数，如：host = $host
- 支持正则表达式，需以^开始，$结束，如:application=^[0-9a-zA-Z-]*$
- 支持SpEL表达式，例如获取请求头参数：#{#request.getHeader("version")}

### Condition条件示例

```java
   
   1）排除预发布机：
   => host != 172.22.3.91
   
   2）黑名单：
   host != 10.20.153.10,10.20.153.11 =>
   
   3）白名单：
   host = 10.20.153.10,10.20.153.11 =>
   
   4）服务寄宿在应用上，只暴露一部分的机器，防止整个集群挂掉：
   => host = 172.22.3.1*,172.22.3.2*
   
   5）为重要应用提供额外的机器：
   application != kylin => host != 172.22.3.95,172.22.3.96
   
   6）前后台分离：
   application = bops => host = 172.22.3.91,172.22.3.92,172.22.3.93
   application != bops => host = 172.22.3.94,172.22.3.95,172.22.3.96
   
   7）隔离不同机房网段：
   host != 172.22.3.* => host != 172.22.3.*
   
   8）提供者与消费者部署在同集群内，本机只访问本机的服务：
   => host = $host
      
   9) 服务消费者只能调用相同版本号的服务提供方：
   => version = $version
      
  10) 指定的用户访问指定的版本的服务，实现灰度发布
   #{#request.getParameter("userId")} = 1 => version = 1.0
```

